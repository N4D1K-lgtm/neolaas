[config]
default_to_workspace = false
skip_core_tasks = true

[env]
CLUSTER_NAME = "infra-dev"
NAMESPACE = "infra"
IMAGE_NAME = "neolaas"
IMAGE_TAG = "dev"
OPERATOR_IMAGE = "neolaas-operator"
KIND_CONTEXT = "kind-infra-dev"

###############################################################################
# Database
###############################################################################

[tasks.install-cnpg]
description = "Install CloudNativePG operator"
command = "kubectl"
args = [
  "apply",
  "--validate=false",
  "-f",
  "https://raw.githubusercontent.com/cloudnative-pg/cloudnative-pg/release-1.22/releases/cnpg-1.22.0.yaml",
]

[tasks.db-port-forward]
description = "Port-forward to PostgreSQL (localhost:5432)"
command = "kubectl"
args = ["port-forward", "-n", "${NAMESPACE}", "svc/neolaas-db-rw", "5432:5432"]

[tasks.db-migrate]
description = "Run database migrations"
env = { "DATABASE_URL" = "postgresql://neolaas:neolaas-dev-password@localhost:5432/neolaas" }
command = "sqlx"
args = ["migrate", "run"]

[tasks.db-create-migration]
description = "Create a new migration file"
command = "sqlx"
args = ["migrate", "add", "-r", "${@}"]

[tasks.db-shell]
description = "Open psql shell to database"
command = "kubectl"
args = [
  "exec",
  "-it",
  "-n",
  "${NAMESPACE}",
  "neolaas-db-1",
  "--",
  "psql",
  "-U",
  "neolaas",
  "-d",
  "neolaas",
]

[tasks.db-prepare]
description = "Generate sqlx-data.json for offline builds"
env = { "DATABASE_URL" = "postgresql://neolaas:neolaas-dev-password@localhost:5432/neolaas" }
command = "cargo"
args = ["sqlx", "prepare", "--workspace"]

###############################################################################
# Bootstrap
###############################################################################

[tasks.kind-up]
description = "Create local kind cluster (idempotent)"
command = "bash"
args = ["deploy/bootstrap/kind/up.sh"]

[tasks.kind-down]
description = "Delete local kind cluster"
command = "kind"
args = ["delete", "cluster", "--name", "${CLUSTER_NAME}"]

###############################################################################
# Build
###############################################################################

[tasks.build-bin]
description = "Build Rust neolaas binary"
command = "cargo"
args = ["build"]

[tasks.build-image]
description = "Build neolaas container image with git metadata"
script = '''
GIT_SHA=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
GIT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")
GIT_COMMIT_TIMESTAMP=$(git log -1 --format=%cI 2>/dev/null || echo "unknown")
GIT_DIRTY=$(git diff --quiet 2>/dev/null && echo "false" || echo "true")

echo "Building ${IMAGE_NAME}:${IMAGE_TAG} with git metadata:"
echo "  SHA: $GIT_SHA"
echo "  Branch: $GIT_BRANCH"
echo "  Commit Time: $GIT_COMMIT_TIMESTAMP"
echo "  Dirty: $GIT_DIRTY"

docker build \
  --build-arg VERGEN_GIT_SHA="$GIT_SHA" \
  --build-arg VERGEN_GIT_BRANCH="$GIT_BRANCH" \
  --build-arg VERGEN_GIT_COMMIT_TIMESTAMP="$GIT_COMMIT_TIMESTAMP" \
  --build-arg VERGEN_GIT_DIRTY="$GIT_DIRTY" \
  -t "${IMAGE_NAME}:${IMAGE_TAG}" \
  -f images/neolaas/Dockerfile \
  .
'''
dependencies = ["build-bin"]

[tasks.kind-load-image]
description = "Load image into kind cluster"
command = "kind"
args = [
  "load",
  "docker-image",
  "${IMAGE_NAME}:${IMAGE_TAG}",
  "--name",
  "${CLUSTER_NAME}",
]
dependencies = ["build-image"]

###############################################################################
# Operator Build
###############################################################################

[tasks.build-operator]
description = "Build neolaas-operator binary"
command = "cargo"
args = ["build", "-p", "neolaas-operator", "--release"]

[tasks.build-operator-image]
description = "Build neolaas-operator container image"
command = "docker"
args = [
  "build",
  "-t",
  "${OPERATOR_IMAGE}:${IMAGE_TAG}",
  "-f",
  "images/neolaas-operator/Dockerfile",
  ".",
]

[tasks.kind-load-operator]
description = "Load operator image into kind cluster"
command = "kind"
args = [
  "load",
  "docker-image",
  "${OPERATOR_IMAGE}:${IMAGE_TAG}",
  "--name",
  "${CLUSTER_NAME}",
]
dependencies = ["build-operator-image"]

[tasks.generate-crds]
description = "Generate CRD manifests from operator"
script = '''
cargo run -p neolaas-operator -- crds > deploy/base/crds/inventory.yaml
'''

###############################################################################
# Deploy
###############################################################################

[tasks.deploy-base]
description = "Deploy base cluster resources (namespace, etcd, CRDs)"
command = "kubectl"
args = ["apply", "-k", "deploy/overlays/dev"]

[tasks.deploy-app]
description = "Deploy neolaas application"
command = "kubectl"
args = ["rollout", "restart", "statefulset/neolaas", "-n", "${NAMESPACE}"]

[tasks.deploy-operator]
description = "Deploy neolaas-operator"
script = '''
kubectl set image -n ${NAMESPACE} deployment/neolaas-operator operator=${OPERATOR_IMAGE}:${IMAGE_TAG} || \
kubectl apply -k deploy/apps/neolaas-operator
'''
dependencies = ["kind-load-operator"]

[tasks.seed-inventory]
description = "Seed test inventory (machines, switches, VLANs)"
command = "kubectl"
args = ["apply", "-f", "deploy/examples/inventory.yaml"]

[tasks.deploy]
description = "Deploy full stack into cluster"
dependencies = [
  "kind-up",
  "install-cnpg",
  "kind-load-image",
  "kind-load-operator",
  "deploy-base",
  "deploy-app",
  "deploy-operator",
]

[tasks.deploy-with-seed]
description = "Deploy full stack and seed test data"
dependencies = ["deploy", "seed-inventory"]

###############################################################################
# Observability
###############################################################################

[tasks.prometheus]
description = "Port-forward Prometheus UI (localhost:9090)"
command = "kubectl"
args = ["port-forward", "-n", "${NAMESPACE}", "svc/prometheus", "9090:9090"]

[tasks.grafana]
description = "Port-forward Grafana UI (localhost:3000)"
command = "kubectl"
args = ["port-forward", "-n", "${NAMESPACE}", "svc/grafana", "3000:3000"]

[tasks.tempo]
description = "Port-forward Tempo API (localhost:3200)"
command = "kubectl"
args = ["port-forward", "-n", "${NAMESPACE}", "svc/tempo", "3200:3200"]

[tasks.loki]
description = "Port-forward Loki API (localhost:3100)"
command = "kubectl"
args = ["port-forward", "-n", "${NAMESPACE}", "svc/loki", "3100:3100"]

[tasks.metrics]
description = "Fetch metrics from neolaas-0"
script = '''
kubectl exec -n ${NAMESPACE} neolaas-0 -- curl -s localhost:8080/metrics | grep neolaas_
'''

[tasks.actors]
description = "Get actor states from neolaas-0"
script = '''
kubectl exec -n ${NAMESPACE} neolaas-0 -- curl -s localhost:8080/actors/machines | jq
'''

[tasks.events]
description = "Tail structured events (requires LOG_FORMAT=json)"
script = '''
kubectl logs -n ${NAMESPACE} -l app=neolaas -f --tail=50 | jq 'select(.event_type)' 2>/dev/null || \
kubectl logs -n ${NAMESPACE} -l app=neolaas -f --tail=50
'''

###############################################################################
# Observe
###############################################################################

[tasks.logs]
description = "Tail neolaas logs"
command = "kubectl"
args = [
  "logs",
  "-n",
  "${NAMESPACE}",
  "-l",
  "app=neolaas",
  "-f",
  "--tail=100",
  "--prefix=true",
]

[tasks.logs-operator]
description = "Tail neolaas-operator logs"
command = "kubectl"
args = [
  "logs",
  "-n",
  "${NAMESPACE}",
  "-l",
  "app=neolaas-operator",
  "-f",
  "--tail=100",
]

[tasks.logs-pod]
description = "Tail specific pod logs (usage: cargo make logs-pod -- neolaas-0)"
command = "kubectl"
args = ["logs", "-n", "${NAMESPACE}", "${@}", "-f"]

[tasks.logs-p2p]
description = "Tail P2P-related logs only"
script = '''
kubectl logs -n ${NAMESPACE} -l app=neolaas -f --prefix=true --tail=50 | grep -E "(neolaas::p2p|P2P network|Peer|PING|PONG)"
'''

[tasks.status]
description = "Show cluster + app status"
command = "kubectl"
args = ["get", "pods", "-n", "${NAMESPACE}", "-o", "wide"]

[tasks.scale]
description = "Scale StatefulSet (usage: cargo make scale -- 3)"
command = "kubectl"
args = ["scale", "statefulset/neolaas", "-n", "${NAMESPACE}", "--replicas=${@}"]

[tasks.scale-up]
description = "Scale StatefulSet to 3 replicas"
command = "kubectl"
args = ["scale", "statefulset/neolaas", "-n", "${NAMESPACE}", "--replicas=3"]

[tasks.scale-down]
description = "Scale StatefulSet to 1 replica"
command = "kubectl"
args = ["scale", "statefulset/neolaas", "-n", "${NAMESPACE}", "--replicas=1"]

[tasks.etcd-check]
description = "Check etcd cluster health"
command = "kubectl"
args = [
  "exec",
  "-n",
  "${NAMESPACE}",
  "etcd-0",
  "--",
  "etcdctl",
  "endpoint",
  "health",
]

[tasks.etcd-get]
description = "Get etcd key (usage: cargo make etcd-get -- /neolaas/resource_locks/host/hpe1)"
command = "kubectl"
args = [
  "exec",
  "-n",
  "${NAMESPACE}",
  "etcd-0",
  "--",
  "etcdctl",
  "get",
  "${@}",
  "--print-value-only",
]

[tasks.etcd-watch]
description = "Watch etcd prefix (usage: cargo make etcd-watch -- /neolaas/)"
command = "kubectl"
args = [
  "exec",
  "-n",
  "${NAMESPACE}",
  "etcd-0",
  "--",
  "etcdctl",
  "watch",
  "--prefix",
  "${@}",
]

###############################################################################
# Inventory Management
###############################################################################

[tasks.get-machines]
description = "List all machines"
command = "kubectl"
args = ["get", "machines", "-A", "-o", "wide"]

[tasks.get-switches]
description = "List all switches"
command = "kubectl"
args = ["get", "switches", "-A", "-o", "wide"]

[tasks.get-vlans]
description = "List all VLANs"
command = "kubectl"
args = ["get", "vlans", "-A", "-o", "wide"]

[tasks.get-inventory]
description = "List all inventory (machines, switches, VLANs)"
script = '''
echo "=== Machines ==="
kubectl get machines -A -o wide
echo ""
echo "=== Switches ==="
kubectl get switches -A -o wide
echo ""
echo "=== VLANs ==="
kubectl get vlans -A -o wide
'''

[tasks.etcd-machines]
description = "List machines synced to etcd"
script = '''
kubectl exec -n ${NAMESPACE} etcd-0 -- etcdctl get /neolaas/machines/ --prefix --keys-only
'''

[tasks.etcd-switches]
description = "List switches synced to etcd"
script = '''
kubectl exec -n ${NAMESPACE} etcd-0 -- etcdctl get /neolaas/switches/ --prefix --keys-only
'''

[tasks.etcd-vlans]
description = "List VLANs synced to etcd"
script = '''
kubectl exec -n ${NAMESPACE} etcd-0 -- etcdctl get /neolaas/vlans/ --prefix --keys-only
'''

[tasks.etcd-inventory]
description = "Show all inventory data in etcd"
script = '''
echo "=== Machines in etcd ==="
kubectl exec -n ${NAMESPACE} etcd-0 -- etcdctl get /neolaas/machines/ --prefix
echo ""
echo "=== Switches in etcd ==="
kubectl exec -n ${NAMESPACE} etcd-0 -- etcdctl get /neolaas/switches/ --prefix
echo ""
echo "=== VLANs in etcd ==="
kubectl exec -n ${NAMESPACE} etcd-0 -- etcdctl get /neolaas/vlans/ --prefix
'''

###############################################################################
# Testing API
###############################################################################

[tasks.port-forward]
description = "Port-forward API to localhost:8080"
command = "kubectl"
args = ["port-forward", "-n", "${NAMESPACE}", "svc/neolaas", "8080:8080"]

[tasks.test-health]
description = "Test health endpoint"
script = '''
curl -f http://localhost:8080/health || echo "Health check failed"
'''

[tasks.test-create-host]
description = "Test creating a host actor"
script = '''
curl -X POST http://localhost:8080/hosts \
  -H "Content-Type: application/json" \
  -d '{
    "host_id": "test-host-1",
    "booking_id": "00000000-0000-0000-0000-000000000001",
    "owner": "test-user",
    "duration_hours": 24
  }' | jq
'''

[tasks.test-provision]
description = "Test provisioning a host"
script = '''
curl -X POST http://localhost:8080/hosts/test-host-1/provision \
  -H "Content-Type: application/json" \
  -d '{
    "image": "ubuntu-22.04",
    "config": {"memory": "16GB"}
  }' | jq
'''

[tasks.test-status]
description = "Test getting host status"
script = '''
curl http://localhost:8080/hosts/test-host-1/status | jq
'''

[tasks.test-p2p-stats]
description = "Test P2P network statistics"
script = '''
curl http://localhost:8080/p2p/stats | jq
'''

[tasks.test-p2p-broadcast]
description = "Test P2P broadcast message"
script = '''
curl -X POST http://localhost:8080/p2p/broadcast \
  -H "Content-Type: application/json" \
  -d '{"content": "Hello from Makefile test!"}' | jq
'''

[tasks.test-all]
description = "Run all API tests (requires port-forward in another terminal)"
dependencies = [
  "test-health",
  "test-create-host",
  "test-provision",
  "test-status",
  "test-p2p-stats",
  "test-p2p-broadcast",
]

[tasks.redeploy]
description = "Fast rebuild + redeploy"
dependencies = ["kind-load-image", "deploy-app"]

###############################################################################
# Cleanup
###############################################################################

[tasks.reset]
description = "Delete infra namespace (DANGEROUS)"
command = "kubectl"
args = ["delete", "namespace", "${NAMESPACE}"]
